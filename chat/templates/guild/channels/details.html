{% extends "layouts/base.html" %}
{% load i18n %}

{% block title %}{{ channel.name }} - {{ APP_NAME }}{% endblock %}

{% block inline_stylesheet %}
    <style>
        #message_input:focus {
            outline: none;
            border: 1px solid #e5e5e5;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="uk-padding-small uk-card-body uk-padding-remove-bottom uk-overflow-auto" id="messages"
         uk-height-viewport="offset-top: true; offset-bottom: true">
        {% with messages=channel.messages.all %}
            {% if messages %}
                {% for message in messages %}
                    {% include "layouts/components/message/block.html" with message=message %}
                {% endfor %}
            {% else %}
                {#                            <div class="uk-text-center">#}
                {#                                {% trans "No message..." %}#}
                {#                            </div>#}

                {% for message in "x"|rjust:"20" %}
                    {% include "layouts/components/message/block.html" with message=message %}
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <div class="uk-card-footer">
        <form id="message_form">
            <label class="uk-flex">
                <button class="uk-button uk-button-default uk-padding-small uk-padding-remove-vertical">
                    <span uk-icon="icon: plus-circle"></span>
                </button>

                <textarea id="message_input" class="uk-textarea"
                          style="resize: none; max-height: 20vh" autofocus
                          rows="2" placeholder="Message {{ channel }}"
                ></textarea>

                <button type="submit"
                        class="uk-button uk-button-primary uk-padding-small uk-padding-remove-vertical">
                    <span uk-icon="icon: forward"></span>
                </button>
            </label>
        </form>
    </div>

    <div id="ws_error_modal" uk-modal>
        <div class="uk-modal-dialog uk-modal-body">
            <h2 class="uk-modal-title uk-text-danger">WebSocket Error</h2>
            <p>
                {% blocktrans %}
                The connection with the websocket could not be established,
                this problem can either come from your connection rules on the network,
                or from a problem on the server.<br>
                You can ignore this error and view your messages without the automatic refresh,
                or try reloading the page.
                {% endblocktrans %}
            </p>
            <p class="uk-text-right">
                <button class="uk-button uk-button-default uk-modal-close" type="button">{% trans "Dismiss" %}</button>
                <a href="{{ request.get_full_path }}" class="uk-button uk-button-primary" type="button">{% trans "Reload" %}</a>
            </p>
        </div>
    </div>
{% endblock %}

{% block inline_javascript %}
    <script>
        const messages = document.getElementById("messages");
        const textarea = document.getElementById("message_input");
        const attachments = undefined;

        const form = document.getElementById("message_form");

        const POST_MESSAGE_ENDPOINT = "{% url 'guild:channel_details' guild.id channel.id %}"

        //////////////////////////////////////////////////////

        const observer = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutationRecord) {
                const style = mutationRecord.target.style;

                if (style) {
                    style.maxHeight = style.minHeight;
                }

                messages.scrollTop = messages.scrollHeight;
            });
        });

        observer.observe(messages, {attributes: true, attributeFilter: ['style']})

        //////////////////////////////////////////////////////

        function send_message() {
            ws.send(JSON.stringify({
                'content': textarea.value,
                'attachments': attachments
            }));

            textarea.value = "";
        }

        function add_message(data) {
            console.log(data)
        }

        form.addEventListener("submit", (e) => {
            e.preventDefault();
            send_message();
        })

        textarea.addEventListener("keyup", (e) => {
            if (e.key === "Enter") {
                if (e.ctrlKey) textarea.value += "\n";
                else send_message();
            }
        })

        //////////////////////////////////////////////////////

        let ws;
        let fail_count = 0;

        (function get_websocket() {
            let chatSocket = new WebSocket(
                'ws://'
                + '127.0.0.1:8000'
                + '/ws/chat/'
                + "{{ guild.id }}"
                + '/'
                + "{{ channel.id }}"
                + '/'
            );

            chatSocket.onmessage = (e) => {
                const data = JSON.parse(e.data);
                add_message(data)
            };

            chatSocket.onopen = (e) => {
                console.log('Websocket connected');
            };

            chatSocket.onclose = (e) => {
                if (fail_count > 2) {
                    UIkit.modal(document.getElementById("ws_error_modal")).show();
                } else {
                    fail_count += 1;
                    console.error('Chat socket closed unexpectedly');
                    console.info('Trying to reconnect in 5s...');
                    setTimeout(() => get_websocket(), 5000)
                }
            };

            ws = chatSocket;
        })();

    </script>
    {% include "layouts/components/message/decryptor.html" %}
{% endblock %}
